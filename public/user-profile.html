<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Document</title>
    <style>

        /* Стиль для экрана загрузки */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Основные стили для страницы */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Секция с контентом */
        .content {
            margin-bottom: 60px; /* Высота панели навигации */
            flex: 1;
/*             padding: 20px; */
            overflow-y: auto;
            background-color: #f4f4f4;
        }

        /* Панель навигации */
        .navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 7px;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: 10px 0;
            user-select: none;
        }

        /* Кнопки на панели */
        .navbar button {
            background: none;
            border: none;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s;
        }

        .navbar button:hover {
            color: #007bff;
        }

        .navbar button.active {
            color: #007bff;
        }

        #profile-inf {
            width: 90%;
            min-height: 105px; /* Можно задать минимальную высоту */
            /* border: 1px solid; */
            margin: auto;
            background: #fff;
            box-shadow: 0 24px 48px #e6ebf566, 0 1px 4px #e3ebfc;
            border-radius: 12px;
            text-align: left;
            align-content: center;
            padding-left: 20px; /* Добавит отступы внутри */
            margin-bottom: 20px; /* Добавляем отступ снизу между профилем и уведомлениями */

        }

        .book-list {
            margin-bottom: 25px;
            width: 93%;
            margin: auto;
            background: #fff;
            box-shadow: 0 24px 48px #e6ebf566, 0 1px 4px #e3ebfc;
            border-radius: 12px;
            padding: 10px 7px;
        }

        /* Заголовок таблицы */
        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            padding: 8px 11px;
            color: black;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: left;
            font-size: 14px;
            border-bottom: 2px solid #ddd; /* Добавил разделение между заголовком и списком */
        }

        /* Делаем текст в заголовке на одной линии */
        .book-header div {
            flex: 1;
            padding: 0 5px;
            white-space: nowrap; /* Запрещаем перенос строки в заголовке */
        }

        /* Название книги в списке */
        .book-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        /* Позволяем тексту переноситься в списке */
        .book-item .book-title {
            flex: 2;
            word-wrap: break-word; /* Позволяет переносу текста */
            padding-left: 46px;
        }

        /* Стили для колонок */
        .book-date {
            font-weight: bold;
            color: #007bff;
        }

        .book-title {
            color: #333;
        }

        .notifications-box {
            width: 90%;
            min-height: 105px; /* Задаем минимальную высоту */
            margin: auto;
            background: #fff;
            box-shadow: 0 24px 48px #e6ebf566, 0 1px 4px #e3ebfc;
            border-radius: 12px;
            text-align: left;
            padding-left: 20px; /* Отступы внутри */
            align-content: center;
            word-wrap: break-word; /* Обеспечивает правильный перенос длинных слов */
        }

        .notifications-box h3 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .notifications-box #notifications-list p {
            margin: 8px 0;
            font-size: 14px;
            color: #666;
            line-height: 1.5; /* Увеличим межстрочный интервал для лучшего восприятия */
        }

        #requests-container {
            user-select: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            }

            .request-item {
            padding: 20px;
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            }

            .request-item:hover {
            background-color: #e0e0e0;
            }

            .btn {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            }

            .btn-primary {
            background-color: #007bff;
            color: white;
            border: none;
            }

            .btn-outline-primary {
            background-color: white;
            color: #007bff;
            border: 1px solid #007bff;
            }

            #request-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            }

        #news-container {
  justify-content: center;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 25px;
}

.news-card {
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  width: 300px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s;
}

/* .news-card:hover {
  transform: translateY(-10px);
} */

.news-card h2 {
  margin: 0 0 10px;
}

.news-card .desc {
  margin: 5px 0;
  white-space: pre-wrap; /* сохраняет переносы строк */
}

.news-card a {
    color: #1e90ff;
    text-decoration: none;
}

.news-card a:hover {
    text-decoration: underline;
}

.news-meta {
    color: #9d9d9d;
    font-size: 15px;
    margin: 8px 0 0;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
}

.news-meta span {
    font-size: 13px;
    padding: 2px 8px;
    border-radius: 999px;
    white-space: nowrap;
}

.tag-default {
    background-color: #f0f0f0;
    color: #333;
}

.tag-app {
    border: 1px solid #1e90ff;
    background-color: transparent;
    color: #000;
}

.sticky-header {
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    background-color: white; /* Можешь поменять цвет */
    padding: 20px 30px; /* Отступы сверху/снизу и по бокам */
    font-size: 28px;
    font-weight: bold;
    z-index: 999; /* Поверх всего */
    border-bottom: 1px solid #ccc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Лёгкая тень */
}

        * {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* * {
            user-select: none;
        } */

    </style>
</head>
<body>

    <div id="loadingScreen">
        <div class="loader"></div>
    </div>

    
    <div class="content" id="content">
        <h1>Добро пожаловать!</h1>
        <p>Выберите одну из опций на панели навигации, чтобы изменить содержимое.</p>
    </div>    

    <div id="timeoutModal" style="display: none;">
    <h3>Выберите время тайм-аута</h3>
    <select id="timeoutSelect">
        <option value="600000">10 минут</option>
        <option value="1800000">30 минут</option>
        <option value="3600000">1 час</option>
        <option value="86400000">1 день</option>
    </select>
    <button onclick="applyTimeout()">Применить</button>
    <button onclick="closeTimeoutModal()">Закрыть</button>
</div>

    <div class="navbar">
        <button id="newsButton" onclick="changeContent('news')">Новости</button>
        <button id="booksButton" onclick="changeContent('books')">Книги</button>
        <button id="profileButton" onclick="changeContent('profile')">Профиль</button>
    </div>

    <script>
    const GOOGLE_SHEET_API = "https://script.google.com/macros/s/AKfycbxWq5SIZ3ps5bib-ZRKztnD-Lfe7-EO8BLaBavusX-Iry74ZDQM_NN-cMEtYhcCN0kr/exec"; // вставь сюда свою ссылку
    let globalUserData = null; // здесь будет храниться объект ученика
    let newsData = []; // здесь будут храниться новости

        window.addEventListener("DOMContentLoaded", async () => {
            // Показываем экран загрузки до загрузки данных
            document.getElementById("loadingScreen").style.display = "flex";

            await loadUserData(); // загрузим данные один раз
            await loadNews(); // загружаем новости один раз

            // Скрываем экран загрузки
            document.getElementById("loadingScreen").style.display = "none";
            
            changeContent("books"); // стартовая вкладка
            
        });
    
        async function loadUserData() {
            const login = localStorage.getItem("login");
            if (!login) return;
    
            const normalizedLogin = login.replace(/\D/g, '');
            const response = await fetch(GOOGLE_SHEET_API);
            const data = await response.json();
            const orgs = data.list1 || [];
    
            for (const org of orgs) {
                const studentsJson = JSON.parse(org.students_json || "{}");
                for (const className in studentsJson) {
                    const students = studentsJson[className];
                    for (const student of students) {
                        const studentPhone = (student["Номер телефона"] || "").replace(/\D/g, "");
                        if (studentPhone === normalizedLogin) {
                            globalUserData = {
                                student,
                                org
                            };
                            return;
                        }
                    }
                }
            }
        }

        // Функция для загрузки новостей
        async function loadNews() {
            const response = await fetch(GOOGLE_SHEET_API);
            const data = await response.json();
            newsData = data.news || [];
        }
    
        async function changeContent(section) {
            const content = document.getElementById("content");
            document.querySelectorAll('.navbar button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`${section}Button`);
            if (activeBtn) activeBtn.classList.add('active');
    
            if (section === 'news') {
                content.innerHTML = `
                <div id="news-header" class="sticky-header">Новости</div>
                <div id="news-container"></div>`;
            
                const newsContainer = document.getElementById('news-container');
            
                function convertLinks(text) {
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
                }
            
                // ✅ Сортируем по дате (новые сверху), при равенстве — последние по счёту первыми
                const sortedNews = [...newsData].sort((a, b) => {
                    const dateA = new Date(a.date.split('.').reverse().join('-'));
                    const dateB = new Date(b.date.split('.').reverse().join('-'));
            
                    if (dateA < dateB) return 1;
                    if (dateA > dateB) return -1;
            
                    // Если дата одинаковая — по порядку в таблице: чем позже в списке, тем выше
                    return newsData.indexOf(b) - newsData.indexOf(a);
                });
            
                sortedNews.forEach(newsItem => {
                    const isMatchingSchool = globalUserData && globalUserData.org.school === newsItem.school;
                    const isAppTag = newsItem.school.startsWith("Приложение:");
            
                    if (isMatchingSchool || isAppTag) {
                        const newsCard = document.createElement('div');
                        newsCard.classList.add('news-card');
            
                        const formattedDate = formatDate(newsItem.date);
            
                        // Генерация тегов в формате #тег
                        let tagsText = `#Школа`;
            
                        if (isAppTag) {
                            const tagRaw = newsItem.school.split(":")[1].trim();
                            const tagItems = tagRaw.split(",").map(t => `#${t.trim()}`);
                            tagsText = tagItems.join(" ");
                        }
            
                        newsCard.innerHTML = `
                            <h2>${newsItem.title}</h2>
                            <p class="desc">${convertLinks(newsItem.desc)}</p>
                            <p style="color: #9d9d9d; font-size: 15px; margin-top: 8px;">
                                ${newsItem.date} <span style="font-size: 10px; margin: 0 6px;">|</span> ${tagsText}
                            </p>
                        `;
            
                        newsContainer.appendChild(newsCard);
                    }
                });
            }



    
            else if (section === 'books') {
                content.innerHTML = `<div id="books-header" class="sticky-header">Книги</div>
                    <div class="book-list" id="book-container">
                        <div class="book-header">
                            <div class="book-date">Дата выдачи</div>
                            <div class="book-title">Автор и заглавие книги</div>
                        </div>
                    </div>`;
                renderBooks();
            }
    
            else if (section === 'profile') {
                content.innerHTML = `
                    <div id="profile-header" class="sticky-header">Профиль</div>
                    <div id="profile-inf">
                        <div id="student-info"></div>
                    </div>
                    <div id="notifications" class="notifications-box">
                        <h3>Уведомления</h3>
                        <div id="notifications-list">
                            <p>В разработке.</p>
                        </div>
                    </div>
                    <button id="logout-btn" style="
                        margin: 30px auto 20px;
                        display: block;
                        padding: 10px 20px;
                        font-size: 16px;
                        border: 1px solid red;
                        background-color: white;
                        color: red;
                        border-radius: 8px;
                        cursor: pointer;
                    ">
                        Выйти
                    </button>
                `;
                renderStudentInfo();
            
                // Обработчик выхода
                document.getElementById("logout-btn").addEventListener("click", () => {
                    localStorage.removeItem("savedLogin");
                    localStorage.removeItem("savedPassword");
                    window.location.href = "index.html"; // назад на страницу входа
                });
            }


        function convertLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
        }

        function renderStudentInfo() {
            const container = document.getElementById("student-info");
            if (!globalUserData) {
                container.innerHTML = "Пользователь не найден.";
                return;
            }
    
            const student = globalUserData.student;
            const org = globalUserData.org;
    
            const fullName = `${student["Фамилия"]} ${student["Имя"]} ${student["Отчество"]}`;
            const education = student["Образование"] || student["Роль"] || "Не указано";
            const schoolName = student["Учебное заведение(Если учится)"] || org.school || "Не указано";
    
            container.innerHTML = `
                <p>${fullName}</p>
                <p>${student["Образование"] ? "Класс" : "Роль"}: ${education}</p>
                <p>Учреждение: ${schoolName}</p>
            `;
        }
    
        function renderBooks() {
            const container = document.getElementById("book-container");
            if (!globalUserData) {
                container.innerHTML += "<p>Ученик не найден.</p>";
                return;
            }
    
            const books = globalUserData.student.books || [];
            if (books.length === 0) {
                container.innerHTML += "<p>Книги отсутствуют.</p>";
                return;
            }
    
            books.forEach(book => {
                const item = document.createElement("div");
                item.className = "book-item";
                item.innerHTML = `
                    <div class="book-date">${book["Дата выдачи"] || "-"}</div>
                    <div class="book-title">${book["Автор и заглавие книги"] || "-"}</div>
                `;
                container.appendChild(item);
            });
        }
    
        function formatDate(date) {
            const dateObj = new Date(date);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
            const year = dateObj.getFullYear();
            return `${day}.${month}.${year}`;
        }
        }
    </script>

    
    
</body>
</html>
